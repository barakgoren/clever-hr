generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  admin
  user
}

enum RoleType {
  full_time
  part_time
  hybrid
  remote
}

enum Plan {
  team
  ultimate
}

model Company {
  id           Int      @id @default(autoincrement())
  name         String
  slug         String   @unique
  description  String?
  heroImageUrl String?
  logoUrl      String?
  plan         Plan     @default(team)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users          User[]
  roles          Role[]
  applications   Application[]
  timeline       ApplicationTimeline[]
  emailTemplates EmailTemplate[]
  emails         ApplicationEmail[]
}

model User {
  id           Int      @id @default(autoincrement())
  companyId    Int
  name         String
  username     String   @unique
  email        String   @unique
  passwordHash String
  role         UserRole @default(user)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company       Company        @relation(fields: [companyId], references: [id])
  roles         Role[]
  refreshTokens RefreshToken[]
  sentEmails    ApplicationEmail[]
}

model Role {
  id              Int      @id @default(autoincrement())
  companyId       Int
  createdByUserId Int
  name            String
  color           String   @default("#6366f1")
  description     String?
  location        String?
  type            RoleType
  seniorityLevel  String?
  requirements    String[]
  isActive        Boolean  @default(true)
  customFields    Json     @default("[]")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company      Company       @relation(fields: [companyId], references: [id])
  createdBy    User          @relation(fields: [createdByUserId], references: [id])
  stages       Stage[]
  applications Application[]
}

model Stage {
  id        Int      @id @default(autoincrement())
  roleId    Int
  name      String
  order     Int
  color     String   @default("#6366f1")
  icon      String   @default("flag")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role         Role          @relation(fields: [roleId], references: [id], onDelete: Cascade)
  applications Application[]
  timeline     ApplicationTimeline[]
}

model Application {
  id             Int      @id @default(autoincrement())
  roleId         Int
  companyId      Int
  currentStageId Int?
  email          String?
  formData       Json     @default("{}")
  resumeS3Key    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  role         Role    @relation(fields: [roleId], references: [id])
  company      Company @relation(fields: [companyId], references: [id])
  currentStage Stage?  @relation(fields: [currentStageId], references: [id], onDelete: SetNull)
  timeline     ApplicationTimeline[]
  emails       ApplicationEmail[]

  @@unique([roleId, email])
}

model ApplicationTimeline {
  id            Int      @id @default(autoincrement())
  applicationId Int
  companyId     Int
  stageId       Int?
  stageName     String
  description   String?
  createdAt     DateTime @default(now())

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  stage       Stage?      @relation(fields: [stageId], references: [id], onDelete: SetNull)
  company     Company     @relation(fields: [companyId], references: [id])
}

model ApplicationEmail {
  id            Int      @id @default(autoincrement())
  applicationId Int
  companyId     Int
  senderUserId  Int
  to            String
  subject       String
  body          String
  html          String
  status        String   @default("sent")
  error         String?
  templateId    Int?
  createdAt     DateTime @default(now())

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id])
  sender      User        @relation(fields: [senderUserId], references: [id])

  @@index([applicationId, createdAt])
  @@index([companyId])
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailTemplate {
  id        Int      @id @default(autoincrement())
  companyId Int
  name      String
  subject   String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}
